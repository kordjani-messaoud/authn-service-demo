pipeline {
    agent any

    environment {
        CONTAINER_REG = "container-reg.icosnet.local"
        VERSION = "1.0"
        IMAGE_NAME = "authn-service-backend"
        IMAGE_TAG = "latest"
        PROJECT =  "sso"
        IMAGE = "${CONTAINER_REG}/${PROJECT}/${IMAGE_NAME}:${VERSION}"
        PATH = "./backend/Dockerfile"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                        // dockerImage = docker.build("${IMAGE}", "-f ${PATH} backend")
                        sh "docker build -t ${IMAGE} -f ${PATH} ./backend "
                        sh "cd ./backend && echo $PWD"
                }
            }
        }

        stage('Push to Local Registry') {
            steps {
                // withCredentials([usernamePassword(credentialsId: 'Harbor', usernameVariable: 'HARBOR_USER', passwordVariable: 'HARBOR_PASS')]) {
                // sh """
                //     echo "$HARBOR_PASS" | docker login ${CONTAINER_REG} -u "$HARBOR_USER" --password-stdin
                //     docker push ${IMAGE}
                //     docker logout ${CONTAINER_REG}
                // """
                // }
                echo "Pushing"
            }
        }
    }
    post {
        success {
            echo "Docker image successfully built and pushed to container-reg.icosnet.local"
        }
        failure {
            echo "Pipeline failed."
        }
    }
}